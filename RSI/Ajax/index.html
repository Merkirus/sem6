<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajax RSI</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>

    <header>

    </header>

    <main>
        <h1>Person</h1>
        <form id="personForm" method="post" action="#">
            <div class="inputs">
                <label for="idInput">ID</label>
                <input type="text" id="idInput">
                <label for="nameInput">Name</label>
                <input type="text" id="nameInput">
                <label for="ageInput">Age</label>
                <input type="text" id="ageInput">
                <label for="statusInput">Status</label>
                <input type="text" id="statusInput">
                <div>
                    <br>
                    <button class="addButton" type="button" id="addOperation" onclick="addPerson()">
                        Add
                    </button>
                    <button type="button" id="clearOperation" onclick="clearInputs()">
                        Clear
                    </button>
                </div>
            </div>
            <div class="updates">
                <label for="nameInput2">Name</label>
                <input type="text" id="nameInput2">
                <label for="ageInput2">Age</label>
                <input type="text" id="ageInput2">
                <label for="statusInput2">Status</label>
                <input type="text" id="statusInput2">
                <div>
                    <br>
                    <button class="updateButton" type="button" id="updateOperation">
                        Update
                    </button>
                    <button type="button" id="clearOperation" onclick="clearInputs2()">
                        Clear
                    </button>
                </div>
            </div>
        </form>

        <br>
        <br>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <!-- <th>Age</th> -->
                    <th>Status</th>
                    <th>Operations</th>
                </tr>
            </thead>
            <tbody id="tableContent">

            </tbody>
        </table>
    </main>

    <footer>

    </footer>

<script>
    const url = 'http://localhost:8080/persons'

    $(function() {
        readAllPersons();
    });

    function clearInputs() {
        $('#idInput').val('');
        $('#nameInput').val('');
        $('#ageInput').val('');
        $('#statusInput').val('');
    }

    function clearInputs2() {
        $('#nameInput2').val('');
        $('#ageInput2').val('');
        $('#statusInput2').val('');
    }

    function readPerson(href) {
        $('#nameInput2').val('');
        $('#ageInput2').val('');
        $('#statusInput2').val('');
        $.ajax({
            type: 'GET',
            url: href,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json'
        })
        .done((response) => {
            $('#nameInput2').val(response.name);
            $('#ageInput2').val(response.age);
            $('#statusInput2').val(response.status);
        })
        .fail((error) => {
            alert(JSON.stringify(error));
        });
    }

    function readAllPersons() {
        $.ajax({
            type: 'GET',
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json'
        })
        .done((response) => {
            $('#tableContent').empty();
            $.each(response._embedded.personList, (index, person) => {
                var row = $('<tr>');
                var operations = $('<td class="opButtons">');
                row.append(`<td>${person.id}</td>`);
                row.append(`<td>${person.name}</td>`);
                // row.append(`<td>${person.age}</td>`);
                row.append(`<td>${person.status.name}</td>`);
                $.each(person._links, (link_name, link) => {
                    if (link_name === 'list all')
                        return false;
                    if (link_name === 'self')
                        link_name = 'edit';
                    var button = $('<button>');
                    if (link_name === 'delete') {
                        button.addClass('deleteButton');
                    }
                    button.text(link_name);
                    button.on("click", function () {
                        operationEvent(link_name, link.href);
                    });
                    operations.append(button);
                });
                row.append(operations);
                $('#tableContent').append(row);
            });
        })
        .fail((error) => {
            alert('XDD');
            console.log(JSON.stringify(error));
            // alert(JSON.stringify(error));
        });
    }

    function operationEvent(event, href) {
        if (event === 'edit') {
            readPerson(href);
            $('#updateOperation').off('click');
            $('#updateOperation').on('click', function() {
                updatePerson(href);
            });
        } else if (event === 'delete') {
            $.ajax({
                type: 'DELETE',
                url: href,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json'
            })
            .done((response) => {
                alert(JSON.stringify(response));
                readAllPersons();
            })
            .fail((error) => {
                alert(JSON.stringify(error));
            });
        } else { // hire etc
            $.ajax({
                type: 'PATCH',
                url: href,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json'
            })
            .done((response) => {
                alert(JSON.stringify(response));
                readAllPersons();
            })
            .fail((error) => {
                alert(JSON.stringify(error));
            });
        }
    }

    function addPerson() {
        const id = parseInt($('#idInput').val());
        const name = $('#nameInput').val();
        const age = parseInt($('#ageInput').val());
        const status = $('#statusInput').val();
        const data = {
            id: id,
            name: name,
            age: age,
            status: status
        };
        $.ajax({
            type: 'POST',
            url: url,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify(data)
        })
        .done((response) => {
            alert(JSON.stringify(response));
            readAllPersons();
        })
        .fail((error) => {
            alert(JSON.stringify(error));
        });
    }

    function updatePerson(href) {
        const arr = href.split('/');
        const _id = arr[arr.length - 1];
        const id = Number(_id);
        const name = $('#nameInput2').val();
        const age = parseInt($('#ageInput2').val());
        const status = $('#statusInput2').val();
        const data = {
            id: id,
            name: name,
            age: age,
            status: status
        };
        $.ajax({
            type: 'PUT',
            url: href,
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify(data)
        })
        .done((response) => {
            alert(JSON.stringify(response));
            readAllPersons();
        })
        .fail((error) => {
            alert(JSON.stringify(error));
        });
    }
</script>

<style>
    table {
        width: 50%;
        margin: 0 auto;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid black;
    }
    th {
        background-color: #f2f2f2;
    }
    form {
        display: grid;
        height: 50%;
    }
    button {
        background-color: lightblue;
        border: 2px solid black;
        border-radius: 10px;
        padding: 5px;
    }
    .inputs {
        display: flex;
        flex-direction: column;
        grid-row: 1;
        grid-column: 1;
        align-items: center;
    }
    .updates {
        display: flex;
        flex-direction: column;
        grid-row: 1;
        grid-column: 2;
        align-items: center;
    }
    .buttons {
        display: flex;
        flex-direction: column;
        grid-row: 1;
        grid-column: 2;
        justify-content: space-between;
        align-items: center;
    }
    .buttons * {
        margin: 2px 0;
    }
    .opButtons {
        display: flex;
        justify-content: space-between;
    }
    .opButtons * {
        margin: 0 5px;
    }
    input[type="text"] {
        border: 2px solid black;
        border-radius: 10px;
    }
    .deleteButton {
        background-color: red;
    }
    .addButton {
        background-color: lightgreen;
    }
    .updateButton {
        background-color: lightyellow;
    }
</style>

</body>

</html>